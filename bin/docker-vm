#!/usr/bin/env bash
set -euo pipefail

VM_NAME="docker"
VM_CPUS=4
VM_MEM="8GiB"
VM_DISK="30GiB"

echo "==> Checking Incus..."
command -v incus >/dev/null

if ! incus info "$VM_NAME" >/dev/null 2>&1; then
	echo "Creating VM..."
	incus launch images:debian/12 \
		"$VM_NAME" \
		--vm \
		-c security.secureboot=false \
		-c limits.cpu="$VM_CPUS" \
		-c limits.memory="$VM_MEM" \
		-d root,size="$VM_DISK"
else
	echo "VM already exists."
	VM_STATUS=$(incus list "$VM_NAME" --format csv --columns s)
	if [ "$VM_STATUS" != "RUNNING" ]; then
		echo "VM is not running (status: $VM_STATUS). Starting..."
		incus start "$VM_NAME"
	else
		echo "VM is already running."
	fi
fi

echo "==> Waiting for VM to become ready..."
TIMEOUT=120
ELAPSED=0
INTERVAL=2

while [ $ELAPSED -lt $TIMEOUT ]; do
	if incus exec "$VM_NAME" -- sh -c 'ping -c1 1.1.1.1 >/dev/null 2>&1' 2>/dev/null; then
		echo "VM is ready!"
		break
	fi
	sleep $INTERVAL
	ELAPSED=$((ELAPSED + INTERVAL))
	echo "Waiting... (${ELAPSED}s/${TIMEOUT}s)"
done

if [ $ELAPSED -ge $TIMEOUT ]; then
	echo "ERROR: VM failed to become ready within ${TIMEOUT} seconds"
	exit 1
fi

USER_NAME="${USER:-$(whoami)}"
PASSWORD="${PASSWORD:-$USER_NAME}"

echo "==> Installing Docker inside VM..."
incus exec "$VM_NAME" -- bash -eux <<EOF
apt-get update
apt-get install -y ca-certificates curl

curl -fsSL https://get.docker.com -o get-docker.sh
sh get-docker.sh

systemctl enable --now docker
systemctl enable --now ssh

addgroup root docker || true

echo "net.ipv4.ip_forward=1" >> /etc/sysctl.d/99-ipforward.conf
sysctl -p /etc/sysctl.d/99-ipforward.conf || true

docker version
docker run --rm hello-world

if ! id "$USER_NAME" >/dev/null 2>&1; then
  useradd -m -s /bin/bash "$USER_NAME"
  echo "$USER_NAME:$PASSWORD" | chpasswd
fi

echo "$USER_NAME ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/$USER_NAME
addgroup "$USER_NAME" docker 2>/dev/null || true
EOF

echo "User '$USER_NAME' created with sudo permissions (password: '$PASSWORD')"
echo "Connect as user: incus exec $VM_NAME -- su - $USER_NAME"
echo "Or via ssh: ssh $USER_NAME@<vm-ip-address>"
echo "Get VM IP with: incus list $VM_NAME --format csv --columns 4"
