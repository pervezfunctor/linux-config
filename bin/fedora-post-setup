#!/usr/bin/env bash

update() {
  sudo dnf update -y
}

firmware() {
  sudo dnf install fwupdmgr -y
  sudo fwupdmgr get-devices
  sudo fwupdmgr refresh --force
  sudo fwupdmgr get-updates
  sudo fwupdmgr update
}

hostname() {
  while true; do
    read -rp "Enter hostname: " hostname
    if [[ -z "$hostname" ]]; then
      echo "Hostname cannot be empty"
      continue
    fi
    break
  done
  sudo hostnamectl set-hostname "$hostname"
}

flathub() {
  flatpak remote-delete fedora
  flatpak remote-add --if-not-exists --subset=verified flathub https://flathub.org/repo/flathub.flatpakrepo
}

nvidia() {
  sudo dnf install -y kernel-devel kernel-headers gcc make dkms acpid libglvnd-glx libglvnd-opengl libglvnd-devel pkgconfig
  sudo dnf install -y \
    https://download1.rpmfusion.org/free/fedora/rpmfusion-free-release-"$(rpm -E %fedora)".noarch.rpm \
    https://download1.rpmfusion.org/nonfree/fedora/rpmfusion-nonfree-release-"$(rpm -E %fedora)".noarch.rpm
  sudo dnf install -y akmod-nvidia xorg-x11-drv-nvidia-cuda

  sudo journalctl -f -u akmods
  nvidia-smi
}

rebuild_nvidia_drivers() {
  sudo akmods --kernels "$(uname -r)" --rebuild
}

amd() {
  sudo dnf install -y mesa-va-drivers-freeworld mesa-vdpau-drivers-freeworld
}

intel() {
  sudo dnf install -y intel-media-driver
}

codecs() {
  sudo dnf swap -y ffmpeg-free ffmpeg --allowerasing

  sudo dnf install -y gstreamer1-plugins-{bad-\*,good-\*,base} \
    gstreamer1-plugin-openh264 gstreamer1-libav lame\* \
    --exclude=gstreamer1-plugins-bad-free-devel

  sudo dnf group install -y multimedia
  sudo dnf group install -y sound-and-video

  sudo dnf install -y openh264 gstreamer1-plugin-openh264 mozilla-openh264

  sudo dnf config-manager --set-enabled fedora-cisco-openh264
  sudo dnf update -y
}

compress() {
  sudo dnf install -y p7zip p7zip-plugins unrar
}

utc() {
  sudo timedatectl set-local-rtc 0 --adjust-system-clock
}

appimage() {
  sudo dnf install -y fuse fuse-libs
  flatpak --user install -y flathub it.mijorus.gearlever
}

fonts() {
  sudo dnf install -y curl cabextract xorg-x11-font-utils fontconfig
  echo "WARNING: Installing unsigned Microsoft Core Fonts from SourceForge."
  sudo rpm -i --nodigest --nosignature https://downloads.sourceforge.net/project/mscorefonts2/rpms/msttcore-fonts-installer-2.6-1.noarch.rpm
}

network() {
  sudo systemctl disable NetworkManager-wait-online.service

  sudo dnf install -y dnsconfd
  sudo systemctl enable --now dnsconfd
  sudo systemctl disable --now systemd-resolved
  sudo systemctl mask systemd-resolved
  sudo mkdir -p /etc/NetworkManager/conf.d
  sudo tee /etc/NetworkManager/conf.d/global-dot.conf >/dev/null <<EOF
[main]
dns=dnsconfd

[global-dns]
resolve-mode=exclusive

[global-dns-domain-*]
servers=dns+tls://1.1.1.1#one.one.one.one
EOF

  sudo systemctl restart NetworkManager
}

btrfs() {
  sudo dnf install -y btrfs-assistant btrbk snapper
  sudo systemctl enable --now snapper-timeline.timer
  sudo systemctl enable --now snapper-cleanup.timer
}

deja-dup() {
  sudo dnf install -y deja-dup
  flatpak install -y flathub org.gnome.DejaDup
}

steam() {
  sudo dnf install -y steam
  sudo dnf install -y mangohud
}

flatpak-steam() {
  sudo dnf remove -y steam
  flatpak install -y flathub com.valvesoftware.Steam
}

brave() {
  sudo dnf install -y dnf-plugins-core
  sudo dnf config-manager --add-repo https://brave-browser-rpm-release.s3.brave.com/brave-browser.repo
  sudo rpm --import https://brave-browser-rpm-release.s3.brave.com/brave-core.asc
  sudo dnf install -y brave-browser
}

librewolf() {
  curl -fsSL https://repo.librewolf.net/librewolf.repo | sudo tee /etc/yum.repos.d/librewolf.repo >/dev/null
  sudo dnf install -y librewolf
}

vscode() {
  sudo rpm --import https://packages.microsoft.com/keys/microsoft.asc
  sudo sh -c 'echo -e "[code]\nname=Visual Studio Code\nbaseurl=https://packages.microsoft.com/yumrepos/vscode\nenabled=1\ngpgcheck=1\ngpgkey=https://packages.microsoft.com/keys/microsoft.asc" > /etc/yum.repos.d/vscode.repo'
  sudo dnf install -y code
}

multimedia() {
  flatpak install -y flathub com.obsproject.Studio
  flatpak install -y flathub org.audacityteam.Audacity
}

gnome() {
  sudo rm /etc/xdg/autostart/org.gnome.Software.desktop
  sudo dnf install -y gnome-tweaks
  sudo dnf install -y gnome-themes-extra
  flatpak install -y flathub com.mattjakeman.ExtensionManager
}

cleanup() {
  sudo dnf clean all
  sudo dnf autoremove -y
}

whiptail_choices() {
  local -a whiptail_items=(
    "update" "Update packages" "on"
    "flathub" "Setup flathub" "on"
    "firmware" "Update firmware" "off"
    "appimage" "Setup appimage support" "on"
    "nvidia" "Install nvidia drivers" "off"
    "rebuild-nvidia-drivers" "Rebuild nvidia drivers" "off"
    "hostname" "Set hostname" "off"
    "codecs" "Install codecs" "off"
    "compress" "Setup zip tools" "off"
    "utc" "Setup time" "off"
    "fonts" "Setup fonts" "off"
    "network" "Setup network" "off"
    "btrfs" "Setup btrfs" "off"
    "deja-dup" "Install deja-dup" "off"
    "steam" "Install steam" "off"
    "flatpak-steam" "Install steam flatpak" "off"
    "brave" "Install brave" "off"
    "librewolf" "Install librewolf" "off"
    "vscode" "Install vscode" "off"
    "multimedia" "Install multimedia tools" "off"
    "gnome" "Setup gnome" "off"
    "cleanup" "Cleanup" "off"
  )

  local selected_output
  selected_output=$(whiptail --checklist "Select tasks to execute:" 25 60 19 "${whiptail_items[@]}" 3>&1 1>&2 2>&3)

  local exit_code=$?
  if [ $exit_code -ne 0 ]; then
    echo "Setup cancelled."
    return 1
  fi

  local -a selected_tasks=()
  if [ -n "$selected_output" ]; then
    read -ra selected_tasks <<<"$selected_output"
  fi

  if [ ${#selected_tasks[@]} -eq 0 ]; then
    echo "No tasks selected."
    return 0
  fi

  for task in "${selected_tasks[@]}"; do
    echo "Executing: $task"
    "$task"
  done
}

whiptail_choices
