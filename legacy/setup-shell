#!/usr/bin/env bash

# shellcheck disable=SC1091
source "$(dirname "${BASH_SOURCE[0]}")/bootstrap"

incus_setup() {
  log "Setting up incus"
  sudo usermod -aG incus "$USER"
  sudo usermod -aG incus-admin "$USER"
  sudo systemctl enable --now incus.socket
  sudo incus admin init --minimal
}

incus_install() {
  if has_cmd incus; then
    log "incus is already installed"
    return
  fi

  log "Installing incus"
  si incus
  incus_setup
}

home-manager_install() {
  has_cmd nix || {
    error "nix is not installed. Please install nix first."
    return 1
  }

  log "Setting up home-manager"
  nix run home-manager -- switch --flake ~/.local/share/linux-config/home-manager\#"$USER" --impure
}

nix_install() {
  has_cmd nix || {
    log "Installing nix"
    curl --proto '=https' --tlsv1.2 -sSf -L https://install.determinate.systems/nix | sh -s -- install --determinate --no-confirm
    # shellcheck disable=SC1091
    source /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
  }
}

system_install() {
  update_packages

  local -a pkgs=(
    cmake
    fish
    gcc
    git
    make
    micro
    rclone
    rsync
    stow
    tar
    tmux
    trash-cli
    tree
    unzip
    zsh
    zstd
  )

  is_tw && pkgs+=(
    gcc-c++
    micro-editor
    python313-pipx
  )
  is_apt && pkgs+=(
    g++
    imagemagick
    starship
    pipx
  )
  is_fedora && pkgs+=(
    g++
    pipx
    nu
  )
  is_arch && pkgs+=(
    g++
    python-pipx
    nushell
  )

  log "Installing system packages"
  si "${pkgs[@]}"

  log "Updating locate database, this may take a while..."
  sudo updatedb
}

pixi_install() {
  log "Installing pixi and shell tools with pixi"

  has_cmd brew || {
    error "brew is not installed. Please install brew first."
    return 1
  }

  brew install pixi

  has_cmd pixi || {
    error "pixi is not installed. Skipping pixi installation."
    return 1
  }

  local -a pixi_pkgs=(
    bash-language-server
    bat
    bottom
    carapace
    direnv
    duf
    eza
    fd
    fzf
    gdu
    gh
    go-gum
    go-shfmt
    jq
    just
    lazygit
    mask
    ripgrep
    shellcheck
    tealdeer
    tectonic
    television
    tmuxp
    xh
    yazi
    zoxide
  )

  pixi global install "${pixi_pkgs[@]}"
  has_cmd starship || pixi global install starship
  has_cmd nushell || pixi global install nushell
  ~/.pixi/bin/tldr --update
}

shell_install() {
  brew_install
  pixi_install
}

rust_install() {
  has_cmd rustup && {
    log "rustup is already installed"
    return
  }

  log "Installing rustup"
  curl --proto '=https' --tlsv1.2 -fsSL https://sh.rustup.rs | sh
}

nushell_setup() {
  if ! grep -q "$(which nu)" /etc/shells; then
    # shellcheck disable=SC2005
    echo "$(which nu)" | sudo tee -a /etc/shells
  fi

  cd ~/.local/share/linux-config && {
    log "Stowing nushell dotfiles"
    stow --no-folding --adopt nushell
    git stash --include-untracked --message "Stashing nushell dotfiles" || true
  }
}

nvim_install() {
  has_cmd nvim || {
    brew install nvim
  }

  if dir_exists ~/.config/nvim; then
    prompt_yn "Found existing nvim config. Do you want to trash and replace with AstroNvim?" || return 1
  fi

  log "Installing AstroNvim"
  trash ~/.config/nvim.bak 2>/dev/null || true
  mv ~/.config/nvim ~/.config/nvim.bak 2>/dev/null || true
  mkdir ~/.config/nvim 2>/dev/null || true
  mv ~/.local/share/nvim ~/.local/share/nvim.bak 2>/dev/null || true
  mv ~/.local/state/nvim ~/.local/state/nvim.bak 2>/dev/null || true
  mv ~/.cache/nvim ~/.cache/nvim.bak 2>/dev/null || true
  git clone --depth 1 https://github.com/AstroNvim/template ~/.config/nvim
  rm -rf ~/.config/nvim/.git
}

zshrc_setup() {
  cd ~/.local/share/linux-config && {
    log "Stowing zsh dotfiles"
    stow --no-folding --adopt zsh
    git stash --include-untracked --message "Stashing zsh dotfiles" || true
  }

  log "Setting zsh as default shell"
  chsh -s "$(which zsh)"
}

bashrc_setup() {
  log "Setting up bashrc"
  grep -q "linux-config/shellrc" ~/.bashrc || {
    echo "source ~/.local/share/linux-config/shellrc" >>~/.bashrc
  }
}

dotfiles_install() {
  dir_exists ~/.local/share/linux-config || dotfiles_clone
  cd ~/.local/share/linux-config || {
    error "Failed to change to linux-config directory"
    return 1
  }

  is_mac || bashrc_setup
  nushell_setup
  zshrc_setup
}

devtools_install() {
  has_cmd mise || {
    curl https://mise.run | sh
  }

  log "Installing devtools(mise, uv etc)"

  brew install uv mise

  eval "$(~/.local/bin/mise activate bash)"
  log "Installing pnpm"
  mise use -g node@latest pnpm

  local pkgi
  if has_cmd pnpm; then
    pnpm setup
    pkgi=pnpm
  else
    pkgi=npm
  fi

  local -a npm_pkgs=(
    @mermaid-js/mermaid-cli
    @google/gemini-cli
    opencode-ai
  )

  log "Installing npm packages"
  for pkg in "${npm_pkgs[@]}"; do
    log "Installing $pkg"
    "$pkgi" install -g "$pkg"
  done
}

claude_install() {
  has_cmd claude && {
    log "claude is already installed"
    return
  }

  log "Installing claude"
  has_cmd claude || {
    curl -fsSL https://claude.ai/install.sh | bash
  }
}

setup-shell() {
  local -a order
  mapfile -t order < <(declare -F | awk '{print $3}' | grep '_install$' | sed 's/_install$//')

  local -a selected_defaults=(dotfiles shell devtools)

  if is_linux && ! is_fedora-atomic; then
    order=(system incus "${order[@]}")
    selected_defaults=(system "${selected_defaults[@]}")
  fi

  is_fedora-atomic || order+=(nix)

  bootstrap

  local selected
  selected=$(printf "%s\n" "${order[@]}" | gum choose --no-limit \
    --header="Select tasks to execute:" \
    --selected="$(printf "%s\n" "${selected_defaults[@]}")") ||
    {
      warn "Setup cancelled."
      return 1
    }

  [[ -z "$selected" ]] && {
    log "No tasks selected."
    return 0
  }

  while IFS= read -r task; do
    log "Executing: $task"
    "${task}_install"
  done <<<"$selected"
}

if [ "${BASH_SOURCE[0]}" == "${0}" ]; then
  setup-shell "$@"
fi
