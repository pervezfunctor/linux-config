#!/usr/bin/env nu

def main [] {
    let includes = [
        {
            path: ($nu.home-path | path join .cargo env.nu)
            cmd: "source"
        }
        {
            path: ($nu.default-config-dir | path join mise.nu)
            cmd: "use"
        }
        {
            path: ($nu.default-config-dir | path join starship.nu)
            cmd: "source"
        }
        {
            path: ($nu.default-config-dir | path join zoxide.nu)
            cmd: "source"
        }
    ]


    let output = $includes
        | where { |item| $item.path | path exists }
        | each { |item|
            if $item.cmd == "use" {
                $"($item.cmd) ($item.path)"
            } else {
                $"($item.cmd) ($item.path)"
            }
        }
        | str join "\n"

    # Add header
    let final = $"# Auto-generated conditional includes
# Generated at (date now | format date '%Y-%m-%d %H:%M:%S')
# Do not edit manually - this file is regenerated automatically

($output)"

    # Save to auto-includes.nu in config directory
    let output_file = $nu.default-config-dir | path join auto-includes.nu

    $final | save --force $output_file

    print $"Generated ($output_file)"
    print $"Included (($includes | where { |item| $item.path | path exists } | length)) files"
}
